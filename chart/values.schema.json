{
  "$id": "http://bigbang.dev/bigbang.json",
  "type": "object",
  "default": {},
  "title": "Big Bang Root Schema",
  "required": [
    "domain",
    "offline",
    "helmRepositories",
    "registryCredentials",
    "openshift",
    "git",
    "sso",
    "flux",
    "networkPolicies",
    "imagePullPolicy",
    "packages"
  ],
  "additionalProperties": false,
  "properties": {
    "domain": {
      "type": "string"
    },
    "offline": {
      "type": "boolean"
    },
    "registryCredentials": {
      "oneOf": [
        {
          "$ref": "#/$defs/registryCredential"
        },
        {
          "type": "array",
          "items": {
            "$ref": "#/$defs/registryCredential"
          },
          "minItems": 1
        }
      ]
    },
    "helmRepositories": {
      "$ref": "#/$defs/helmRepositories"
    },
    "openshift": {
      "type": "boolean"
    },
    "git": {
      "type": "object",
      "properties": {
        "existingSecret": {
          "type": "string"
        },
        "credentials": {
          "type": "object",
          "properties": {
            "username": {
              "type": "string"
            },
            "password": {
              "type": "string"
            },
            "caFile": {
              "type": "string"
            },
            "privateKey": {
              "type": "string"
            },
            "publicKey": {
              "type": "string"
            },
            "knownHosts": {
              "type": "string"
            }
          },
          "anyOf": [
            {
              "required": [
                "username",
                "password"
              ]
            },
            {
              "required": [
                "privateKey",
                "publicKey",
                "knownHosts"
              ]
            }
          ],
          "additionalProperties": false
        }
      },
      "anyOf": [
        {
          "required": [
            "existingSecret"
          ]
        },
        {
          "required": [
            "credentials"
          ]
        }
      ],
      "additionalProperties": false
    },
    "sso": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "url": {
          "type": "string"
        },
        "certificateAuthority": {
          "type": "object",
          "properties": {
            "cert": {
              "type": "string"
            },
            "secretName": {
              "type": "string"
            }
          },
          "additionalProperties": false
        },
        "saml": {
          "type": "object",
          "properties": {
            "entityDescriptor": {
              "type": "string"
            },
            "service": {
              "type": "string"
            },
            "metadata": {
              "type": "string"
            }
          },
          "additionalProperties": false
        },
        "oidc": {
          "type": "object",
          "properties": {
            "authorization": {
              "type": "string"
            },
            "endSession": {
              "type": "string"
            },
            "jwksUri": {
              "type": "string"
            },
            "token": {
              "type": "string"
            },
            "userinfo": {
              "type": "string"
            },
            "jwks": {
              "type": "string"
            },
            "claims": {
              "type": "object",
              "properties": {
                "email": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                },
                "username": {
                  "type": "string"
                },
                "groups": {
                  "type": "string"
                }
              }
            }
          }
        }
      },
      "additionalProperties": false
    },
    "flux": {
      "$ref": "#/$defs/flux"
    },
    "networkPolicies": {
      "type": "object",
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "controlPlaneCidr": {
          "type": "string"
        },
        "nodeCidr": {
          "type": "string"
        },
        "vpcCidr": {
          "type": "string"
        }
      },
      "required": [
        "enabled"
      ]
    },
    "imagePullPolicy": {
      "type": "string",
      "enum": [
        "Never",
        "Always",
        "IfNotPresent"
      ]
    },
    "packages": {
      "type": "object",
      "required": [
        "core",
        "addons"
      ],
      "properties": {
        "core": {
          "type": "object",
          "required": [
            "istio",
            "istioOperator",
            "istioCore",
            "istioGateway",
            "kyverno",
            "kyvernoPolicies"
          ],
          "additionalProperties": false,
          "properties": {
            "istio": {
              "$ref": "#/properties/istio"
            },
            "istioOperator": {
              "$ref": "#/properties/istioOperator"
            },
            "istioCore": {
              "$ref": "#/properties/istioCore"
            },
            "istioGateway": {
              "$ref": "#/properties/istioGateway"
            },
            "kyverno": {
              "$ref": "#/properties/kyverno"
            },
            "kyvernoPolicies": {
              "$ref": "#/properties/kyvernoPolicies"
            }
          }
        },
        "addons": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "jaeger": {
              "$ref": "#/properties/jaeger"
            },
            "kiali": {
              "$ref": "#/properties/kiali"
            },
            "gatekeeper": {
              "$ref": "#/properties/gatekeeper"
            },
            "kyvernoReporter": {
              "$ref": "#/properties/kyvernoReporter"
            },
            "elasticsearchKibana": {
              "$ref": "#/properties/elasticsearchKibana"
            },
            "eckOperator": {
              "$ref": "#/properties/eckOperator"
            },
            "fluentbit": {
              "$ref": "#/properties/fluentbit"
            },
            "promtail": {
              "$ref": "#/properties/promtail"
            },
            "loki": {
              "$ref": "#/properties/loki"
            },
            "neuvector": {
              "$ref": "#/properties/neuvector"
            },
            "tempo": {
              "$ref": "#/properties/tempo"
            },
            "monitoring": {
              "$ref": "#/properties/monitoring"
            },
            "grafana": {
              "$ref": "#/properties/grafana"
            },
            "twistlock": {
              "$ref": "#/properties/twistlock"
            },
            "clusterAuditor": {
              "$ref": "#/properties/clusterAuditor"
            },
            "minioOperator": {
              "$ref": "#/properties/minioOperator"
            },
            "minio": {
              "$ref": "#/properties/minio"
            },
            "gitlab": {
              "$ref": "#/properties/gitlab"
            },
            "gitlabRunner": {
              "$ref": "#/properties/gitlabRunner"
            },
            "nexusRepositoryManager": {
              "$ref": "#/properties/nexusRepositoryManager"
            },
            "sonarqube": {
              "$ref": "#/properties/sonarqube"
            },
            "fortify": {
              "$ref": "#/properties/fortify"
            },
            "haproxy": {
              "$ref": "#/properties/haproxy"
            },
            "anchore": {
              "$ref": "#/properties/anchore"
            },
            "mattermostOperator": {
              "$ref": "#/properties/mattermostOperator"
            },
            "mattermost": {
              "$ref": "#/properties/mattermost"
            },
            "velero": {
              "$ref": "#/properties/velero"
            },
            "keycloak": {
              "$ref": "#/properties/keycloak"
            },
            "vault": {
              "$ref": "#/properties/vault"
            },
            "metricsServer": {
              "$ref": "#/properties/metricsServer"
            },
            "harbor": {
              "$ref": "#/properties/harbor"
            },
            "holocron": {
              "$ref": "#/properties/holocron"
            },
            "thanos": {
              "$ref": "#/properties/thanos"
            },
            "externalSecrets": {
              "$ref": "#/properties/externalSecrets"
            },
            "alloy": {
              "$ref": "#/properties/alloy"
            },
            "mimir": {
              "$ref": "#/properties/mimir"
            }
          }
        }
      },
      "additionalProperties": false
    },
    "wrapper": {
      "type": "object",
      "properties": {
        "sourceType": {
          "$ref": "#/$defs/sourceType"
        },
        "git": {
          "$ref": "#/$defs/git"
        },
        "helmRepo": {
          "$ref": "#/$defs/helmRepo"
        }
      },
      "additionalProperties": false
    }
  },
  "$defs": {
    "registryCredential": {
      "type": "object",
      "properties": {
        "registry": {
          "type": "string"
        },
        "username": {
          "type": "string"
        },
        "password": {
          "type": "string"
        },
        "email": {
          "type": "string"
        }
      },
      "required": [
        "registry",
        "username",
        "password"
      ],
      "additionalProperties": false
    },
    "helmRepositories": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string"
          },
          "repository": {
            "type": "string",
            "format": "uri"
          },
          "existingSecret": {
            "type": "string"
          },
          "provider": {
            "type": "string",
            "enum": [
              "generic",
              "aws",
              "azure",
              "gcp"
            ]
          },
          "type": {
            "type": "string",
            "enum": [
              "oci",
              "default"
            ]
          },
          "username": {
            "type": "string"
          },
          "password": {
            "type": "string"
          },
          "email": {
            "type": "string"
          },
          "cosignPublicKey": {
            "type": "string"
          }
        },
        "anyOf": [
          {
            "required": [
              "existingSecret"
            ]
          },
          {
            "required": [
              "username",
              "password"
            ]
          },
          {
            "required": [
              "provider"
            ],
            "not": {
              "properties": {
                "provider": {
                  "const": "generic"
                }
              }
            }
          }
        ],
        "required": [
          "name",
          "repository"
        ]
      }
    },
    "basePackage": {
    "type": "object",
    "required": [
        "enabled",
        "sourceType",
        "flux",
        "values",
        "postRenderers"
    ],
    "if": {
        "properties": {
        "sourceType": {
            "const": "git"
        }
        }
    },
    "then": {
        "properties": {
        "gitRepository": {
            "$ref": "#/$defs/gitRepository"
        }
        },
        "required": [
        "gitRepository"
        ]
    },
    "else": {
        "properties": {
        "helmRepo": {
            "$ref": "#/$defs/helmRepo"
        }
        },
        "required": [
        "helmRepo"
        ]
    },
    "properties": {
        "enabled": {
        "$ref": "#/$defs/enabled"
        },
        "sourceType": {
        "enum": [
            "git",
            "helmRepo"
        ]
        },
        "flux": {
        "$ref": "#/$defs/flux"
        },
        "values": {
        "$ref": "#/$defs/values"
        },
        "postRenderers": {
        "$ref": "#/$defs/postRenderers"
        }
    }
    },
    "gitRepository": {
    "type": "object",
    "required": ["ref"],
    "properties": {
        "ref": {
        "$ref": "#/$defs/git"
        }
    },
    "additionalProperties": false
    },
    "values": {
      "type": "object",
      "default": {},
      "required": [],
      "properties": {}
    },
    "flux": {
      "install": {
        "description": "Configuration for Helm install actions.",
        "type": "object",
        "properties": {
          "crds": {
            "description": "CRD upgrade policy.",
            "type": "string",
            "enum": [
              "Skip",
              "Create",
              "CreateReplace"
            ]
          },
          "createNamespace": {
            "description": "Create the target namespace if it does not exist.",
            "type": "boolean"
          },
          "disableHooks": {
            "description": "Disable hooks during install.",
            "type": "boolean"
          },
          "disableOpenAPIValidation": {
            "description": "Disable OpenAPI validation.",
            "type": "boolean"
          },
          "disableWait": {
            "description": "Disable waiting for resources.",
            "type": "boolean"
          },
          "disableWaitForJobs": {
            "description": "Disable waiting for jobs.",
            "type": "boolean"
          },
          "remediation": {
            "description": "Configuration for remediation on failure.",
            "type": "object",
            "properties": {
              "ignoreTestFailures": {
                "type": "boolean"
              },
              "remediateLastFailure": {
                "type": "boolean"
              },
              "retries": {
                "type": "integer"
              }
            }
          },
          "replace": {
            "type": "boolean"
          },
          "skipCRDs": {
            "type": "boolean"
          },
          "timeout": {
            "type": "string",
            "pattern": "^([0-9]+(\\.[0-9]+)?(ms|s|m|h))+$"
          }
        }
      },
      "interval": {
        "description": "Reconciliation interval.",
        "type": "string",
        "pattern": "^([0-9]+(\\.[0-9]+)?(ms|s|m|h))+$"
      },
      "kubeConfig": {
        "description": "KubeConfig for remote reconciliation.",
        "type": "object",
        "required": [
          "secretRef"
        ],
        "properties": {
          "secretRef": {
            "description": "Reference to the secret containing the kubeconfig.",
            "type": "object",
            "required": [
              "name"
            ],
            "properties": {
              "key": {
                "type": "string"
              },
              "name": {
                "type": "string"
              }
            }
          }
        }
      },
      "maxHistory": {
        "description": "Maximum number of revisions to keep.",
        "type": "integer"
      },
      "persistentClient": {
        "description": "Use a persistent Kubernetes client.",
        "type": "boolean"
      },
      "releaseName": {
        "description": "Helm release name.",
        "type": "string",
        "maxLength": 53,
        "minLength": 1
      },
      "rollback": {
        "description": "Configuration for Helm rollback actions.",
        "type": "object",
        "properties": {
          "cleanupOnFail": {
            "type": "boolean"
          },
          "disableHooks": {
            "type": "boolean"
          },
          "disableWait": {
            "type": "boolean"
          },
          "disableWaitForJobs": {
            "type": "boolean"
          },
          "force": {
            "type": "boolean"
          },
          "recreate": {
            "type": "boolean"
          },
          "timeout": {
            "type": "string",
            "pattern": "^([0-9]+(\\.[0-9]+)?(ms|s|m|h))+$"
          }
        }
      },
      "serviceAccountName": {
        "type": "string"
      },
      "storageNamespace": {
        "type": "string",
        "maxLength": 63,
        "minLength": 1
      },
      "suspend": {
        "type": "boolean"
      },
      "test": {
        "type": "object",
        "properties": {
          "enable": {
            "type": "boolean"
          },
          "ignoreFailures": {
            "type": "boolean"
          },
          "timeout": {
            "type": "string",
            "pattern": "^([0-9]+(\\.[0-9]+)?(ms|s|m|h))+$"
          }
        }
      },
      "timeout": {
        "type": "string",
        "pattern": "^([0-9]+(\\.[0-9]+)?(ms|s|m|h))+$"
      },
      "uninstall": {
        "type": "object",
        "properties": {
          "deletionPropagation": {
            "type": "string",
            "default": "background",
            "enum": [
              "background",
              "foreground",
              "orphan"
            ]
          },
          "disableHooks": {
            "type": "boolean"
          },
          "disableWait": {
            "type": "boolean"
          },
          "keepHistory": {
            "type": "boolean"
          },
          "timeout": {
            "type": "string",
            "pattern": "^([0-9]+(\\.[0-9]+)?(ms|s|m|h))+$"
          }
        }
      },
      "upgrade": {
        "type": "object",
        "properties": {
          "cleanupOnFail": {
            "type": "boolean"
          },
          "crds": {
            "type": "string",
            "enum": [
              "Skip",
              "Create",
              "CreateReplace"
            ]
          },
          "disableHooks": {
            "type": "boolean"
          },
          "disableOpenAPIValidation": {
            "type": "boolean"
          },
          "disableWait": {
            "type": "boolean"
          },
          "disableWaitForJobs": {
            "type": "boolean"
          },
          "force": {
            "type": "boolean"
          },
          "preserveValues": {
            "type": "boolean"
          },
          "remediation": {
            "type": "object",
            "properties": {
              "ignoreTestFailures": {
                "type": "boolean"
              },
              "remediateLastFailure": {
                "type": "boolean"
              },
              "retries": {
                "type": "integer"
              },
              "strategy": {
                "type": "string",
                "enum": [
                  "rollback",
                  "uninstall"
                ]
              }
            }
          },
          "timeout": {
            "type": "string",
            "pattern": "^([0-9]+(\\.[0-9]+)?(ms|s|m|h))+$"
          }
        }
      },
      "values": {
        "description": "Helm values for the release.",
        "x-kubernetes-preserve-unknown-fields": true
      }
    },
    "git": {
      "type": "object",
      "required": [
        "repo",
        "path"
      ],
      "anyOf": [
        {
          "required": [
            "tag"
          ],
          "properties": {
            "branch": {
              "maxLength": 0
            },
            "commit": {
              "maxLength": 0
            }
          }
        },
        {
          "required": [
            "branch"
          ],
          "properties": {
            "tag": {
              "maxLength": 0
            }
          }
        },
        {
          "required": [
            "semver"
          ],
          "properties": {
            "branch": {
              "maxLength": 0
            },
            "commit": {
              "maxLength": 0
            },
            "tag": {
              "maxLength": 0
            }
          }
        }
      ],
      "dependentRequired": {
        "commit": [
          "branch"
        ]
      },
      "properties": {
        "repo": {
          "type": "string",
          "examples": [
            "https://repo1.dso.mil/big-bang/product/packages/loki.git"
          ]
        },
        "path": {
          "type": "string",
          "examples": [
            "./chart"
          ]
        },
        "tag": {
          "type": [
            "string",
            "null"
          ],
          "nullable": false,
          "examples": [
            "4.8.0-bb.0"
          ]
        },
        "branch": {
          "minLength": 1,
          "type": [
            "string",
            "null"
          ],
          "nullable": false,
          "examples": [
            "feature-branch"
          ]
        },
        "commit": {
          "type": "string"
        },
        "semver": {
          "type": "string"
        },
        "existingSecret": {
          "type": "string"
        },
        "credentials": {
          "type": "object",
          "properties": {
            "username": {
              "type": "string"
            },
            "password": {
              "type": "string"
            },
            "caFile": {
              "type": "string"
            },
            "privateKey": {
              "type": "string"
            },
            "publicKey": {
              "type": "string"
            },
            "knownHosts": {
              "type": "string"
            }
          },
          "anyOf": [
            {
              "required": [
                "username",
                "password"
              ]
            },
            {
              "required": [
                "privateKey",
                "publicKey",
                "knownHosts"
              ]
            }
          ],
          "additionalProperties": false
        }
      },
      "additionalProperties": false,
      "examples": [
        {
          "repo": "https://repo1.dso.mil/big-bang/product/packages/loki.git",
          "path": "./chart",
          "tag": "4.8.0-bb.0"
        }
      ]
    },
    "postRenderers": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/$defs/postRenderersArray"
          }
        },
        {
          "$ref": "#/$defs/postRenderersArray"
        }
      ]
    },
    "enabled": {
      "type": "boolean",
      "default": false,
      "examples": [
        false
      ]
    },
    "sso": {
      "type": "object",
      "required": [
        "enabled",
        "client_id",
        "client_secret"
      ],
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "client_id": {
          "type": "string"
        },
        "client_secret": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "ingress": {
      "type": "object",
      "properties": {
        "gateway": {
          "type": "string"
        }
      },
      "additionalProperties": false
    },
    "helmRepo": {
      "type": "object",
      "properties": {
        "repoName": {
          "type": "string"
        },
        "chartName": {
          "type": "string"
        },
        "tag": {
          "type": "string"
        },
        "cosignVerify": {
          "type": "boolean"
        }
      },
      "required": [
        "repoName",
        "chartName",
        "tag"
      ],
      "additionalProperties": false
    },
    "sourceType": {
      "enum": [
        "helmRepo",
        "git"
      ]
    },
    "istio": {
      "type": "object",
      "properties": {
        "injection": {
          "enum": [
            "enabled",
            "disabled"
          ]
        }
      }
    }
  }
}