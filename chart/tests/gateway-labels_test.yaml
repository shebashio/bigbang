suite: test argocd values
templates:
  - argocd/values.yaml
postRenderer:
  cmd: "yq"
  args:
    - ".stringData.defaults |= (.|from_yaml)"
tests:
  - it: should render istio gateway label selectors by default (operator)
    set:
      addons.argocd.enabled: true
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.defaults.networkPolicies.istioNamespaceSelector
          value:
            ingress: istio-controlplane
            egress: istio-controlplane
      - equal:
          path: stringData.defaults.networkPolicies.ingressLabels
          value:
            app: public-ingressgateway
            istio: null
  - it: should render istio gateway label correctly if set to passthrough (operator)
    values:
      - ../../tests/test-values.yaml
    set:
      addons.argocd.enabled: true
      addons.argocd.ingress.gateway: "passthrough"
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.defaults.networkPolicies.istioNamespaceSelector
          value:
            ingress: istio-controlplane
            egress: istio-controlplane
      - equal:
          path: stringData.defaults.networkPolicies.ingressLabels
          value:
            app: passthrough-ingressgateway
            istio: null
  - it: should render istio gateway label selectors correctly with test-values (operatorless)
    values:
      - ../../tests/test-values.yaml
    set:
      addons.argocd.enabled: true
      addons.argocd.ingress.gateway: "passthrough"
      istiod.enabled: true
      istioCRDs.enabled: true
      istioGateway.enabled: true
      istio.enabled: false
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: stringData.defaults.networkPolicies.istioNamespaceSelector
          value:
            ingress: istio-gateway
            egress: istio-system
      - equal:
          path: stringData.defaults.networkPolicies.ingressLabels
          value:
            app: passthrough-ingressgateway
            istio: null