{{- if or .Values.kyverno.enabled .Values.kyvernoPolicies.enabled .Values.kyvernoReporter.enabled }}
{{- include "values-secret" (dict 
"root" $ 
"package" .Values.kyverno 
"name" "kyverno" 
"defaults" ((mergeOverwrite (include "bigbang.defaults.kyverno" . | fromYaml) (include "bigbang.kyverno.bb-common-migrations" . | fromYaml)) | toYaml) 
)}}
{{- end }}

{{- define "bigbang.defaults.kyverno" -}}
{{- $istioEnabled := eq (include "istioEnabled" .) "true" }}

istio:
  enabled: {{ $istioEnabled }}

networkPolicies:
  enabled: {{ .Values.networkPolicies.enabled }}
  # Setting to false as Kyverno is not in the mesh
  hbonePortInjection:
    enabled: false
  ingress:
    defaults:
      allowPrometheusToIstioSidecar:
        enabled: false
    definitions:
      kubeAPI:
        from:
          - ipBlock:
              cidr: 192.168.0.0/16
          - ipBlock:
              cidr: 172.16.0.0/12
          - ipBlock:
              cidr: 10.0.0.0/8
    to:
      kyverno-admission-controller:9443:
        podSelector:
          matchLabels:
            app.kubernetes.io/component: admission-controller
        from:
          definition:
            kubeAPI: true
      kyverno:8000:
        podSelector:
          matchLabels:
            app.kubernetes.io/instance: kyverno-kyverno
        from:
          k8s:
            monitoring/prometheus: {{ .Values.monitoring.enabled }}
  egress:
    defaults:
      allowIstiod:
        enabled: false
    definitions:
      private-registry:
        to:
          - ipBlock:
              cidr: "15.205.173.153/32"
        ports:
          - port: 443
            protocol: TCP
    from:
      kyverno-admission-controller:
        podSelector:
          matchLabels:
            app.kubernetes.io/component: admission-controller
        to:
          definition:
            private-registry: {{ (dig "policies" "require-image-signature" "enabled" true .Values.kyvernoPolicies.values) }}
            kubeAPI: true
openshift: {{ .Values.openshift }}

upstream:

  fullnameOverride: kyverno-kyverno

  replicaCount: 3

  image:
    pullSecrets:
    - name: private-registry
    pullPolicy: {{ .Values.imagePullPolicy }}

  grafana:
    enabled: {{ .Values.monitoring.enabled }}
    namespace: monitoring

  admissionController:
    serviceMonitor:
      enabled: {{ .Values.monitoring.enabled }}

  backgroundController:
    serviceMonitor:
      enabled: {{ .Values.monitoring.enabled }}

  cleanupController:
    serviceMonitor:
      enabled: {{ .Values.monitoring.enabled }}

  reportsController:
    serviceMonitor:
      enabled: {{ .Values.monitoring.enabled }}


{{- end -}}
