{{- /* Used for creating values for the package's Helm chart */ -}}
{{- range $pkg, $vals := .Values.packages -}}
{{- if (dig "enabled" true $vals) -}}
{{- $pkg = include "resourceName" $pkg -}}
{{- $defaults := $.Files.Get (printf "defaults/%s.yaml" $pkg) -}}
{{- if $defaults -}}
{{- $vals := mergeOverwrite $vals ($defaults | fromYaml).package -}}
{{- end -}}
{{- /* BB Maintained flag - when true, inject addon-like values automatically */ -}}
{{- $bbMaintained := dig "bb_maintained" false $vals -}}
{{- $istioEnabled := eq (include "istioEnabled" $) "true" -}}
{{- $hardenedEnabled := or (dig "values" "istio" "hardened" "enabled" false $vals) (dig "hardened" "enabled" false $.Values.istiod.values) -}}
{{- $domainName := default $.Values.domain $.Values.hostname -}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $pkg }}-values
  namespace:  {{ if dig "helmRelease" "namespace" nil (index $.Values.packages $pkg) }}
                {{ dig "helmRelease" "namespace" "" (index $.Values.packages $pkg) }}
              {{ else }}
                {{ default (dig "namespace" "name" $pkg $vals) "" }}
              {{ end }}
  labels:
    {{- include "commonLabels" $ | nindent 4 }}
type: Opaque
stringData:
  {{- if (not $vals.kustomize) }}

  {{- if or ($vals.values) (dig "passBigBangValues" true $vals) $bbMaintained }}
  values.yaml: |-
    {{ if (dig "passBigBangValues" true $vals) -}}
    bigbang:
      {{- include "values-bigbang" $.Values | nindent 6 }}
    {{- end }}
    {{- /* BB Maintained: Merge package values with injected values, bb_maintained takes precedence */ -}}
    {{- if $bbMaintained }}
    {{- /* Start with package values as base */ -}}
    {{- $mergedValues := $vals.values | default dict -}}
    {{- /* Build bb_maintained injected values */ -}}
    {{- $bbIstio := dict "enabled" $istioEnabled "hardened" (dict "enabled" $hardenedEnabled) "injection" (dig "istio" "injection" "enabled" $vals) $pkg (dict "gateways" (list (include "getGatewayName" (dict "gateway" (dig "ingress" "gateway" "" $vals) "root" $)))) -}}
    {{- $bbMonitoring := dict "enabled" $.Values.monitoring.enabled -}}
    {{- if and $istioEnabled $.Values.monitoring.enabled -}}
    {{- $bbMonitoring = merge $bbMonitoring (dict "serviceMonitor" (dict "scheme" "https" "tlsConfig" (dict "caFile" "/etc/prom-certs/root-cert.pem" "certFile" "/etc/prom-certs/cert-chain.pem" "keyFile" "/etc/prom-certs/key.pem" "insecureSkipVerify" true))) -}}
    {{- end -}}
    {{- $pkgIngress := dict "ingress" (dict "gateway" (dig "ingress" "gateway" "" $vals)) -}}
    {{- $bbNetPol := dict "enabled" $.Values.networkPolicies.enabled "ingressLabels" (include "getGatewaySelector" (dict "pkg" $pkgIngress "root" $) | fromYaml) "istioNamespaceSelector" (include "istioNamespaceSelector" $ | fromYaml) -}}
    {{- $bbValues := dict "domain" $domainName "openshift" $.Values.openshift "istio" $bbIstio "monitoring" $bbMonitoring "networkPolicies" $bbNetPol -}}
    {{- if $istioEnabled -}}
    {{- $bbValues = merge $bbValues (dict "podAnnotations" (include "istioAnnotation" $ | fromYaml)) -}}
    {{- end -}}
    {{- /* Merge: package values first, then bb_maintained on top (bb_maintained wins for conflicts) */ -}}
    {{- $mergedValues = mergeOverwrite (deepCopy $mergedValues) $bbValues -}}
    {{- /* Deep merge istio.hardened to preserve customServiceEntries while ensuring enabled is set */ -}}
    {{- if and (hasKey $vals.values "istio") (hasKey (index $vals.values "istio") "hardened") -}}
    {{- $pkgHardened := index (index $vals.values "istio") "hardened" -}}
    {{- $mergedHardened := mergeOverwrite (deepCopy $pkgHardened) (dict "enabled" $hardenedEnabled) -}}
    {{- $_ := set (index $mergedValues "istio") "hardened" $mergedHardened -}}
    {{- end -}}
    # Auto-injected by BigBang for bb_maintained packages (merged with package values)
    {{- tpl (toYaml $mergedValues) $ | nindent 4 }}
    {{- else }}
    {{- /* Non-bb_maintained: just output package values */ -}}
    {{- if $vals.values -}}
    {{- tpl (toYaml $vals.values) $ | nindent 4 }}
    {{- end }}
    {{- end }}
  {{ else }}
  values.yaml: "{}"
  {{- end }}

  {{- else }}
  {{- /* Kustomize path */ -}}
  {{- if or ($vals.values) (dig "passBigBangValues" true $vals) $bbMaintained }}
  {{- if (dig "passBigBangValues" true $vals) }}
  bigbang:
    {{- include "values-bigbang" $.Values | nindent 6 }}
  {{- end }}
  {{- /* BB Maintained: Merge package values with injected values (kustomize path) */ -}}
  {{- if $bbMaintained }}
  {{- /* Start with package values as base */ -}}
  {{- $mergedValues := $vals.values | default dict -}}
  {{- /* Build bb_maintained injected values */ -}}
  {{- $bbIstio := dict "enabled" $istioEnabled "hardened" (dict "enabled" $hardenedEnabled) "injection" (dig "istio" "injection" "enabled" $vals) $pkg (dict "gateways" (list (include "getGatewayName" (dict "gateway" (dig "ingress" "gateway" "" $vals) "root" $)))) -}}
  {{- $bbMonitoring := dict "enabled" $.Values.monitoring.enabled -}}
  {{- if and $istioEnabled $.Values.monitoring.enabled -}}
  {{- $bbMonitoring = merge $bbMonitoring (dict "serviceMonitor" (dict "scheme" "https" "tlsConfig" (dict "caFile" "/etc/prom-certs/root-cert.pem" "certFile" "/etc/prom-certs/cert-chain.pem" "keyFile" "/etc/prom-certs/key.pem" "insecureSkipVerify" true))) -}}
  {{- end -}}
  {{- $pkgIngress := dict "ingress" (dict "gateway" (dig "ingress" "gateway" "" $vals)) -}}
  {{- $bbNetPol := dict "enabled" $.Values.networkPolicies.enabled "ingressLabels" (include "getGatewaySelector" (dict "pkg" $pkgIngress "root" $) | fromYaml) "istioNamespaceSelector" (include "istioNamespaceSelector" $ | fromYaml) -}}
  {{- $bbValues := dict "domain" $domainName "openshift" $.Values.openshift "istio" $bbIstio "monitoring" $bbMonitoring "networkPolicies" $bbNetPol -}}
  {{- if $istioEnabled -}}
  {{- $bbValues = merge $bbValues (dict "podAnnotations" (include "istioAnnotation" $ | fromYaml)) -}}
  {{- end -}}
  {{- /* Merge: package values first, then bb_maintained on top (bb_maintained wins for conflicts) */ -}}
  {{- $mergedValues = mergeOverwrite (deepCopy $mergedValues) $bbValues -}}
  {{- /* Deep merge istio.hardened to preserve customServiceEntries while ensuring enabled is set */ -}}
  {{- if and (hasKey $vals.values "istio") (hasKey (index $vals.values "istio") "hardened") -}}
  {{- $pkgHardened := index (index $vals.values "istio") "hardened" -}}
  {{- $mergedHardened := mergeOverwrite (deepCopy $pkgHardened) (dict "enabled" $hardenedEnabled) -}}
  {{- $_ := set (index $mergedValues "istio") "hardened" $mergedHardened -}}
  {{- end -}}
  # Auto-injected by BigBang for bb_maintained packages (merged with package values)
  {{- tpl (toYaml $mergedValues) $ | nindent 2 }}
  {{- else }}
  {{- /* Non-bb_maintained: just output package values */ -}}
  {{- if $vals.values -}}
  {{- tpl (toYaml $vals.values) $ | nindent 2 }}
  {{- end }}
  {{- end }}
  {{- else }}
  {}
  {{- end }}

  {{ end }}
  
---
{{ end -}}
{{- end -}}